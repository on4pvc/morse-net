<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morse Iambic Multi-Channel v2.2 - Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            border: 4px solid #0f0;
            box-shadow: 0 0 20px #0f0;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #001a00;
            border-right: 4px solid #0f0;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #0f0;
            background: linear-gradient(180deg, #003300 0%, #001a00 100%);
        }

        .logo h1 {
            font-size: 18px;
            color: #0ff;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            margin-bottom: 5px;
        }

        .logo .subtitle {
            font-size: 11px;
            color: #0f0;
        }

        .logo .online-badge {
            display: inline-block;
            background: #0f0;
            color: #000;
            padding: 2px 8px;
            font-size: 10px;
            margin-top: 5px;
            animation: glow 1s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #0f0; }
            to { box-shadow: 0 0 15px #0f0, 0 0 25px #0f0; }
        }

        .channels-header {
            padding: 10px 15px;
            background: #002200;
            border-bottom: 1px solid #0a0;
            color: #0ff;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .total-users {
            color: #ff0;
        }

        .channels {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .channel-section {
            margin-bottom: 15px;
        }

        .channel-section-title {
            font-size: 10px;
            color: #0aa;
            padding: 5px 10px;
            border-bottom: 1px dashed #0a0;
            margin-bottom: 5px;
        }

        .channel-item {
            padding: 12px 15px;
            margin: 4px 0;
            background: #002200;
            border: 2px solid #0a0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-item:hover {
            background: #003300;
            border-color: #0ff;
            box-shadow: 0 0 10px #0f0;
        }

        .channel-item.active {
            background: #004400;
            border-color: #0ff;
            box-shadow: 0 0 15px #0ff;
        }

        .channel-item.private {
            border-color: #ff0;
        }

        .channel-item.private .channel-name {
            color: #ff0;
        }

        .channel-item.private::before {
            content: "üîí ";
        }

        .channel-item.lobby {
            border-color: #f0f;
        }

        .channel-item.lobby .channel-name {
            color: #f0f;
        }

        .channel-item.practice {
            border-color: #fa0;
        }

        .channel-item.practice .channel-name {
            color: #fa0;
        }

        .channel-name {
            color: #0f0;
            font-size: 13px;
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-count {
            font-size: 11px;
            color: #0ff;
            background: #003333;
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid #0aa;
        }

        .channel-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0f0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .channel-status.active-status {
            background: #0ff;
            animation: pulseActive 0.5s infinite;
        }

        @keyframes pulseActive {
            0%, 100% { opacity: 0.5; box-shadow: 0 0 5px #0ff; }
            50% { opacity: 1; box-shadow: 0 0 15px #0ff; }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(180deg, #001a1a 0%, #000a0a 100%);
            padding: 15px 20px;
            border-bottom: 3px solid #0ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-title-area {
            display: flex;
            flex-direction: column;
        }

        .channel-title {
            font-size: 22px;
            color: #0ff;
            text-shadow: 0 0 10px #0ff;
        }

        .channel-description {
            font-size: 11px;
            color: #0a0;
            margin-top: 3px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .settings-btn, .clear-btn {
            padding: 10px 20px;
            background: #003333;
            border: 2px solid #0ff;
            color: #0ff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: all 0.2s;
        }

        .settings-btn:hover, .clear-btn:hover {
            background: #004444;
            box-shadow: 0 0 15px #0ff;
        }

        .clear-btn {
            border-color: #f55;
            color: #f55;
        }

        .clear-btn:hover {
            box-shadow: 0 0 15px #f55;
        }

        /* Practice Mode Bar */
        .practice-bar {
            display: none;
            background: linear-gradient(180deg, #1a1100 0%, #0a0800 100%);
            border-bottom: 2px solid #fa0;
            padding: 10px 20px;
        }

        .practice-bar.active {
            display: block;
        }

        .practice-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .bot-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bot-avatar {
            font-size: 24px;
        }

        .bot-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .bot-callsign {
            color: #fa0;
            font-weight: bold;
            font-size: 14px;
        }

        .bot-name {
            color: #ca0;
            font-size: 11px;
        }

        .qso-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qso-state {
            background: #2a1800;
            border: 1px solid #fa0;
            padding: 5px 12px;
            font-size: 11px;
            color: #fa0;
        }

        .qso-state.active {
            animation: pulseBorder 1s infinite;
        }

        @keyframes pulseBorder {
            0%, 100% { border-color: #fa0; }
            50% { border-color: #ff0; box-shadow: 0 0 10px #fa0; }
        }

        .bot-controls {
            display: flex;
            gap: 10px;
        }

        .bot-btn {
            padding: 8px 15px;
            background: #1a1100;
            border: 2px solid #fa0;
            color: #fa0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.2s;
        }

        .bot-btn:hover {
            background: #2a1800;
            box-shadow: 0 0 10px #fa0;
        }

        .bot-btn.start {
            border-color: #0f0;
            color: #0f0;
        }

        .bot-btn.start:hover {
            box-shadow: 0 0 10px #0f0;
        }

        /* Morse Display Area */
        .morse-display {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(180deg, #000a00 0%, #001100 100%);
        }

        .morse-line {
            margin: 6px 0;
            padding: 10px 12px;
            background: #001100;
            border-left: 4px solid #0a0;
            animation: fadeIn 0.3s;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 10px;
        }

        .morse-line.current {
            border-left-color: #0ff;
            background: #001a1a;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        .morse-line.system {
            border-left-color: #f0f;
            background: #1a001a;
        }

        .morse-line.other-user {
            border-left-color: #0af;
            background: #001a1a;
        }

        .morse-line.bot-message {
            border-left-color: #fa0;
            background: #1a1100;
        }

        .morse-line.bot-message.bot-sending {
            animation: botPulse 0.5s infinite alternate;
        }

        @keyframes botPulse {
            from { background: #1a1100; }
            to { background: #2a1800; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .morse-timestamp {
            font-size: 10px;
            color: #0a0;
            min-width: 60px;
        }

        .morse-user {
            color: #0ff;
            font-weight: bold;
            min-width: 100px;
        }

        .morse-user.other {
            color: #0af;
        }

        .morse-user.bot {
            color: #fa0;
        }

        .morse-user.system {
            color: #f0f;
        }

        .morse-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .morse-code {
            color: #ff0;
            font-size: 14px;
            letter-spacing: 3px;
            opacity: 0.8;
        }

        .morse-text {
            color: #0f0;
            font-size: 16px;
            letter-spacing: 1px;
        }

        .morse-text .cursor {
            animation: blink 0.5s infinite;
            color: #0ff;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Muted overlay for Lobby */
        .muted-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
        }

        .muted-overlay.active {
            display: flex;
        }

        .muted-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .muted-text {
            font-size: 18px;
            color: #f0f;
            text-align: center;
            line-height: 1.6;
        }

        /* Display wrapper */
        .display-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(180deg, #002200 0%, #001a00 100%);
            padding: 12px 20px;
            border-top: 3px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-left, .status-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            color: #0aa;
            font-size: 11px;
        }

        .status-value {
            color: #0ff;
            font-weight: bold;
            font-size: 13px;
            background: #002222;
            padding: 3px 10px;
            border: 1px solid #0aa;
        }

        .key-indicators {
            display: flex;
            gap: 5px;
        }

        .key-indicator {
            width: 70px;
            height: 35px;
            border: 2px solid #0a0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            background: #001100;
            transition: all 0.05s;
        }

        .key-indicator.dit { border-color: #0f0; }
        .key-indicator.dah { border-color: #0ff; }

        .key-indicator.active.dit {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 20px #0f0;
        }

        .key-indicator.active.dah {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 20px #0ff;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, #002200 0%, #001a00 100%);
            border: 4px solid #0ff;
            box-shadow: 0 0 40px #0ff, inset 0 0 20px rgba(0, 255, 255, 0.1);
            padding: 30px;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            color: #0ff;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 0 15px #0ff;
            border-bottom: 2px solid #0ff;
            padding-bottom: 15px;
        }

        .setting-group {
            margin: 18px 0;
            padding: 15px;
            background: #001a00;
            border: 2px solid #0a0;
        }

        .setting-group-title {
            color: #0ff;
            font-size: 12px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .setting-label {
            color: #0aa;
            font-size: 13px;
            margin-bottom: 8px;
            display: block;
        }

        input[type="range"] {
            width: 100%;
            height: 10px;
            background: #003300;
            border: 1px solid #0a0;
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(180deg, #0ff 0%, #0aa 100%);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 15px #0ff;
            border: 2px solid #fff;
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(180deg, #0ff 0%, #0aa 100%);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 15px #0ff;
            border: 2px solid #fff;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            background: #001100;
            border: 2px solid #0a0;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #0ff;
            box-shadow: 0 0 15px #0ff;
        }

        .value-display {
            color: #ff0;
            font-size: 20px;
            margin-top: 8px;
            text-align: center;
            text-shadow: 0 0 10px #ff0;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            padding: 10px;
            background: #002200;
            cursor: pointer;
        }

        .checkbox-group:hover {
            background: #003300;
        }

        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #0ff;
        }

        select {
            width: 100%;
            padding: 12px;
            background: #001100;
            border: 2px solid #0a0;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #0ff;
            box-shadow: 0 0 15px #0ff;
        }

        select option {
            background: #001100;
            color: #0f0;
        }

        .btn {
            padding: 14px 20px;
            background: #003333;
            border: 2px solid #0ff;
            color: #0ff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
        }

        .btn:hover {
            background: #004444;
            box-shadow: 0 0 20px #0ff;
        }

        .btn.secondary {
            border-color: #0a0;
            color: #0a0;
            margin-top: 10px;
        }

        .btn.secondary:hover {
            box-shadow: 0 0 20px #0a0;
        }

        .close-btn {
            margin-top: 20px;
            background: #330000;
            border-color: #f55;
            color: #f55;
        }

        .close-btn:hover {
            background: #440000;
            box-shadow: 0 0 20px #f55;
        }

        /* Bot settings section */
        .setting-group.bot-settings {
            border-color: #fa0;
            background: #1a1100;
        }

        .setting-group.bot-settings .setting-group-title {
            color: #fa0;
        }

        .setting-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .setting-row > div {
            flex: 1;
        }

        .info-box {
            margin-top: 12px;
            padding: 12px;
            background: #0a0a00;
            border: 1px dashed #aa0;
            font-size: 11px;
            color: #ff0;
            line-height: 1.5;
        }

        .info-box.bot-info {
            border-color: #fa0;
            color: #fa0;
            background: #0a0500;
        }

        /* Private channels info */
        .private-channels-info {
            margin-top: 12px;
            padding: 12px;
            background: #1a1a00;
            border: 1px solid #aa0;
            font-size: 11px;
            color: #ff0;
            line-height: 1.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 14px;
        }

        ::-webkit-scrollbar-track {
            background: #001100;
            border: 1px solid #0a0;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0a0 0%, #050 100%);
            border: 1px solid #0ff;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #0f0 0%, #0a0 100%);
        }

        /* CRT Effect */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 9999;
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 15px;
            font-size: 12px;
            z-index: 10000;
            border-radius: 3px;
        }

        .connection-status.connected {
            background: #002200;
            border: 1px solid #0f0;
            color: #0f0;
        }

        .connection-status.disconnected {
            background: #220000;
            border: 1px solid #f00;
            color: #f00;
            animation: blink 1s infinite;
        }

        .connection-status.connecting {
            background: #222200;
            border: 1px solid #ff0;
            color: #ff0;
        }

        /* QSO Help Panel */
        .qso-help {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            background: #001a00;
            border: 2px solid #0a0;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .qso-help.active {
            display: block;
        }

        .qso-help-title {
            color: #0ff;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #0a0;
            padding-bottom: 5px;
        }

        .qso-help-content {
            font-size: 11px;
            color: #0f0;
            line-height: 1.6;
        }

        .qso-help-content code {
            background: #002200;
            padding: 2px 5px;
            color: #ff0;
        }

        .help-toggle {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #002200;
            border: 2px solid #0a0;
            color: #0f0;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
        }

        .help-toggle:hover {
            background: #003300;
            border-color: #0ff;
        }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    <div class="connection-status connecting" id="connectionStatus">‚è≥ Connecting...</div>
    
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>‚ö° MORSE NET ‚ö°</h1>
                <div class="subtitle">IAMBIC MULTI-CHANNEL v2.2</div>
                <div class="online-badge">üåê ONLINE</div>
            </div>
            <div class="channels-header">
                <span>üì° CHANNELS</span>
                <span class="total-users" id="totalUsers">üë• 0 online</span>
            </div>
            <div class="channels" id="channelsList">
                <!-- Channels rendered by JS -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="channel-title-area">
                    <div class="channel-title" id="channelTitle">LOBBY</div>
                    <div class="channel-description" id="channelDescription">Canal d'accueil - Mode silencieux</div>
                </div>
                <div class="header-buttons">
                    <button class="clear-btn" onclick="clearDisplay()">üóëÔ∏è CLEAR</button>
                    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è SETTINGS</button>
                </div>
            </div>

            <!-- Practice Mode Bar -->
            <div class="practice-bar" id="practiceBar">
                <div class="practice-bar-content">
                    <div class="bot-info">
                        <div class="bot-avatar">ü§ñ</div>
                        <div class="bot-details">
                            <div class="bot-callsign" id="botCallsign">-</div>
                            <div class="bot-name" id="botName">En attente...</div>
                        </div>
                    </div>
                    <div class="qso-status">
                        <div class="qso-state" id="qsoState">IDLE</div>
                    </div>
                    <div class="bot-controls">
                        <button class="bot-btn start" onclick="startBotQSO()">‚ñ∂ START QSO</button>
                        <button class="bot-btn" onclick="resetBot()">‚Ü∫ RESET</button>
                    </div>
                </div>
            </div>

            <div class="display-wrapper">
                <div class="morse-display" id="morseDisplay">
                    <!-- Morse messages will appear here -->
                </div>

                <div class="muted-overlay" id="mutedOverlay">
                    <div class="muted-icon">üîá</div>
                    <div class="muted-text">
                        <strong>LOBBY - Mode Silencieux</strong><br><br>
                        Ce canal est un espace d'accueil.<br>
                        Personne ne peut voir ou entendre les autres.<br><br>
                        Rejoignez un autre canal pour communiquer!
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-left">
                    <div class="status-item">
                        <span class="status-label">WPM:</span>
                        <span class="status-value" id="wpmDisplay">20</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">FREQ:</span>
                        <span class="status-value" id="freqDisplay">700 Hz</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">MODE:</span>
                        <span class="status-value" id="modeDisplay">IAMBIC-B</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">USER:</span>
                        <span class="status-value" id="userDisplay">VISITOR</span>
                    </div>
                </div>
                <div class="status-right">
                    <div class="key-indicators">
                        <div class="key-indicator dit" id="ditIndicator">‚óè DIT</div>
                        <div class="key-indicator dah" id="dahIndicator">‚ñ¨ DAH</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Toggle -->
    <button class="help-toggle" id="helpToggle" onclick="toggleHelp()">?</button>

    <!-- QSO Help Panel -->
    <div class="qso-help" id="qsoHelp">
        <div class="qso-help-title">üìö Aide QSO</div>
        <div class="qso-help-content" id="qsoHelpContent">
            <strong>Proc√©dure CW standard:</strong><br><br>
            1. <code>CQ CQ DE [CALL] K</code> - Appel g√©n√©ral<br>
            2. <code>[CALL] DE [MYCALL] K</code> - R√©pondre<br>
            3. <code>RST 599 NAME [X] QTH [X]</code> - Rapport<br>
            4. <code>73 SK</code> - Fin du QSO<br><br>
            <strong>Abr√©viations:</strong><br>
            ‚Ä¢ GM/GA/GE = Good Morning/Afternoon/Evening<br>
            ‚Ä¢ TU/TNX = Thank you<br>
            ‚Ä¢ FB = Fine Business (tr√®s bien)<br>
            ‚Ä¢ HW = How (comment)<br>
            ‚Ä¢ UR = Your/You are
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">‚öôÔ∏è SETTINGS ‚öôÔ∏è</div>

            <div class="setting-group">
                <div class="setting-group-title">üë§ Identit√©</div>
                <label class="setting-label">CALLSIGN / USERNAME</label>
                <input type="text" id="username" placeholder="Entrez votre indicatif..." value="VISITOR" maxlength="12">
            </div>

            <div class="setting-group">
                <div class="setting-group-title">üéöÔ∏è Vitesse</div>
                <label class="setting-label">SPEED (WPM)</label>
                <input type="range" id="wpmSlider" min="5" max="50" value="20">
                <div class="value-display" id="wpmValue">20 WPM</div>
            </div>

            <div class="setting-group">
                <div class="setting-group-title">üîä Audio</div>
                <label class="setting-label">TONE FREQUENCY (Hz)</label>
                <input type="range" id="freqSlider" min="300" max="1200" value="700">
                <div class="value-display" id="freqValue">700 Hz</div>
            </div>

            <div class="setting-group">
                <div class="setting-group-title">üéõÔ∏è Mode Keyer</div>
                <label class="setting-label">IAMBIC MODE</label>
                <select id="iambicMode">
                    <option value="A">IAMBIC-A (Standard)</option>
                    <option value="B" selected>IAMBIC-B (Altern√©)</option>
                </select>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="reverseKeys">
                    <label class="setting-label" style="margin: 0; cursor: pointer;">REVERSE PADDLES (DIT ‚Üî DAH)</label>
                </div>
            </div>

            <div class="setting-group bot-settings">
                <div class="setting-group-title">ü§ñ Bot QSO (Practice)</div>
                
                <div class="setting-row">
                    <div>
                        <label class="setting-label">TYPE DE QSO</label>
                        <select id="botQsoType">
                            <option value="casual">Casual (Standard)</option>
                            <option value="ragchew">Ragchew (Long)</option>
                            <option value="contest">Contest (Rapide)</option>
                            <option value="dx">DX (Minimal)</option>
                        </select>
                    </div>
                    <div>
                        <label class="setting-label">DIFFICULT√â</label>
                        <select id="botDifficulty">
                            <option value="beginner">D√©butant</option>
                            <option value="intermediate">Interm√©diaire</option>
                            <option value="advanced">Avanc√©</option>
                        </select>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="botAutoStart" checked>
                    <label class="setting-label" style="margin: 0; cursor: pointer;">D√©marrer automatiquement le bot</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="showBotAnalysis">
                    <label class="setting-label" style="margin: 0; cursor: pointer;">Afficher l'analyse des messages (debug)</label>
                </div>

                <div class="info-box bot-info">
                    ü§ñ <strong>Bot Intelligent:</strong> Le bot simule des QSO r√©alistes. 
                    Il comprend vos messages et r√©pond de mani√®re contextuelle selon la proc√©dure CW standard.
                    Essayez d'appeler CQ ou r√©pondez √† son appel!
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-group-title">üîí Canaux Priv√©s</div>
                <label class="setting-label">CR√âER / REJOINDRE DES CANAUX PRIV√âS</label>
                <input type="text" id="privateChannels" placeholder="Ex: CLUB73, SECRET, TEAM-DX">
                <div class="private-channels-info">
                    üí° <strong>Comment √ßa marche:</strong><br>
                    ‚Ä¢ Entrez les noms de canaux s√©par√©s par des virgules<br>
                    ‚Ä¢ Seuls les utilisateurs avec le m√™me nom verront ce canal<br>
                    ‚Ä¢ Les canaux sont partag√©s en temps r√©el!
                </div>
                <button class="btn secondary" onclick="applyPrivateChannels()">‚úì APPLIQUER CANAUX PRIV√âS</button>
            </div>

            <button class="btn close-btn" onclick="closeSettings()">‚úï FERMER</button>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // ========== SOCKET CONNECTION ==========
        var socket = io();
        var isConnected = false;

        // ========== CONFIGURATION ==========
        var config = {
            wpm: 20,
            frequency: 700,
            mode: 'B',
            reverse: false,
            username: 'VISITOR',
            privateChannels: [],
            botQsoType: 'casual',
            botDifficulty: 'beginner',
            botAutoStart: true,
            showBotAnalysis: false
        };

        var currentChannel = 'LOBBY';
        var audioContext = null;
        var oscillator = null;
        var gainNode = null;
        var channelUserCounts = {};

        // Bot state
        var botState = {
            profile: null,
            qsoState: 'idle',
            isActive: false
        };

        // Other users' oscillators
        var otherUsersAudio = {};

        // ========== CHANNEL DATA ==========
        var channelData = {
            LOBBY: { name: 'Lobby', description: "Canal d'accueil - Mode silencieux", type: 'lobby' },
            PRACTICE: { name: 'Practice', description: 'Entra√Ænement avec Bot QSO intelligent', type: 'practice' },
            CH1: { name: 'Channel 1', description: 'Canal de communication', type: 'normal' },
            CH2: { name: 'Channel 2', description: 'Canal de communication', type: 'normal' },
            CH3: { name: 'Channel 3', description: 'Canal de communication', type: 'normal' },
            CH4: { name: 'Channel 4', description: 'Canal de communication', type: 'normal' },
            CH5: { name: 'Channel 5', description: 'Canal de communication', type: 'normal' },
            CH6: { name: 'Channel 6', description: 'Canal de communication', type: 'normal' },
            CH7: { name: 'Channel 7', description: 'Canal de communication', type: 'normal' },
            CH8: { name: 'Channel 8', description: 'Canal de communication', type: 'normal' }
        };

        // ========== MORSE CODE TABLE ==========
        var morseTable = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--',
            '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..',
            '9': '----.', '0': '-----', '/': '-..-.', '?': '..--..', '.': '.-.-.-',
            ',': '--..--', '=': '-...-', '+': '.-.-.'
        };

        var reverseMorseTable = {};
        for (var key in morseTable) {
            reverseMorseTable[morseTable[key]] = key;
        }

        // ========== KEYER STATE ==========
        var keyerState = {
            ditPressed: false,
            dahPressed: false,
            isPlaying: false,
            lastElement: null,
            currentMorse: '',
            currentText: '',
            lastKeyTime: 0,
            currentLineElement: null,
            lineTimeout: null,
            letterTimeout: null,
            wordTimeout: null
        };

        // ========== SOCKET EVENTS ==========
        socket.on('connect', function() {
            isConnected = true;
            updateConnectionStatus('connected');
            console.log('Connected to server');
            
            socket.emit('joinChannel', {
                channelId: currentChannel,
                username: config.username
            });
        });

        socket.on('disconnect', function() {
            isConnected = false;
            updateConnectionStatus('disconnected');
            console.log('Disconnected from server');
        });

        socket.on('channelUsers', function(counts) {
            channelUserCounts = counts;
            renderChannels();
        });

        socket.on('userJoined', function(data) {
            addSystemMessage(data.username + ' a rejoint le canal');
        });

        socket.on('userLeft', function(data) {
            addSystemMessage(data.username + ' a quitt√© le canal');
        });

        // ========== BOT EVENTS ==========
        socket.on('botReady', function(state) {
            console.log('Bot ready:', state);
            botState = state;
            updateBotDisplay();
            
            if (config.botAutoStart) {
                addSystemMessage('ü§ñ Bot CW pr√™t. Appuyez sur START QSO ou tapez CQ pour commencer!');
            }
        });

        socket.on('botStarted', function(data) {
            console.log('Bot started:', data);
            botState.profile = data.profile;
            botState.qsoState = data.qsoState.state;
            botState.isActive = true;
            updateBotDisplay();
        });

        socket.on('botMessage', function(data) {
            console.log('Bot message:', data);
            
            // Update state
            if (data.qsoState) {
                botState.qsoState = data.qsoState.state;
                updateBotDisplay();
            }
            
            // Display message
            addBotMessage(data.callsign, data.morse, data.text);
            
            // Play morse audio
            if (data.morse) {
                playReceivedMorse(data.morse);
            }
        });

        socket.on('botReset', function(state) {
            console.log('Bot reset:', state);
            botState = state || { profile: null, qsoState: 'idle', isActive: false };
            updateBotDisplay();
            addSystemMessage('üîÑ Bot r√©initialis√©. Pr√™t pour un nouveau QSO.');
        });

        socket.on('qsoEnded', function(data) {
            console.log('QSO ended:', data);
            var duration = Math.round(data.duration / 1000);
            addSystemMessage('‚úÖ QSO termin√©! Dur√©e: ' + duration + 's, √âchanges: ' + data.exchanges);
            addSystemMessage('üí° Cliquez START QSO ou tapez CQ pour un nouveau QSO.');
            
            botState.qsoState = 'ended';
            botState.isActive = false;
            updateBotDisplay();
        });

        socket.on('messageAnalysis', function(analysis) {
            console.log('Message analysis:', analysis);
            
            if (config.showBotAnalysis) {
                var detected = [];
                if (analysis.detected.isCQ) detected.push('CQ');
                if (analysis.detected.isGreeting) detected.push('Greeting');
                if (analysis.detected.isReport) detected.push('Report');
                if (analysis.detected.isClosing) detected.push('Closing');
                
                if (detected.length > 0) {
                    addSystemMessage('üìä D√©tect√©: ' + detected.join(', '));
                }
                
                if (analysis.extracted.callsign) {
                    addSystemMessage('üìä Callsign: ' + analysis.extracted.callsign);
                }
            }
        });

        // Receive morse from other users
        socket.on('morseStart', function(data) {
            startOtherUserTone(data.senderId);
        });

        socket.on('morseStop', function(data) {
            stopOtherUserTone(data.senderId);
        });

        socket.on('morseMessage', function(data) {
            addOtherUserMessage(data.username, data.morse, data.text);
        });

        function updateConnectionStatus(status) {
            var el = document.getElementById('connectionStatus');
            el.className = 'connection-status ' + status;
            if (status === 'connected') {
                el.textContent = 'üü¢ Connected';
            } else if (status === 'disconnected') {
                el.textContent = 'üî¥ Disconnected';
            } else {
                el.textContent = '‚è≥ Connecting...';
            }
        }

        // ========== BOT FUNCTIONS ==========
        function updateBotDisplay() {
            var callsignEl = document.getElementById('botCallsign');
            var nameEl = document.getElementById('botName');
            var stateEl = document.getElementById('qsoState');
            
            if (botState.profile) {
                callsignEl.textContent = botState.profile.callsign;
                nameEl.textContent = botState.profile.name + ' - ' + botState.profile.qth + ', ' + botState.profile.country;
            } else {
                callsignEl.textContent = '-';
                nameEl.textContent = 'En attente...';
            }
            
            // Format state for display
            var stateText = botState.qsoState || 'idle';
            stateText = stateText.toUpperCase().replace(/_/g, ' ');
            stateEl.textContent = stateText;
            
            if (botState.isActive) {
                stateEl.classList.add('active');
            } else {
                stateEl.classList.remove('active');
            }
        }

        function startBotQSO() {
            if (currentChannel !== 'PRACTICE') {
                alert('Le bot QSO n\'est disponible que dans le canal Practice!');
                return;
            }
            
            socket.emit('startBotQSO', {
                qsoType: config.botQsoType,
                difficulty: config.botDifficulty
            });
            
            addSystemMessage('üöÄ D√©marrage du QSO...');
        }

        function resetBot() {
            socket.emit('resetBot');
        }

        // ========== TIMING ==========
        function getDitLength() {
            return 1200 / config.wpm;
        }

        function getDahLength() {
            return getDitLength() * 3;
        }

        function getElementSpace() {
            return getDitLength();
        }

        function getLetterSpace() {
            return getDitLength() * 4;
        }

        function getWordSpace() {
            return getDitLength() * 7;
        }

        // ========== AUDIO ==========
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function startTone() {
            var channelType = channelData[currentChannel] ? channelData[currentChannel].type : 'normal';
            if (channelType === 'lobby') return;
            
            initAudio();
            if (oscillator) return;

            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(config.frequency, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.008);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            
            // Broadcast to others (not in practice mode)
            if (channelType === 'normal') {
                socket.emit('morseStart', { channelId: currentChannel });
            }
        }

        function stopTone() {
            if (oscillator && gainNode) {
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.008);
                
                var osc = oscillator;
                setTimeout(function() {
                    try { osc.stop(); } catch(e) {}
                }, 15);
                
                oscillator = null;
                gainNode = null;
                
                var channelType = channelData[currentChannel] ? channelData[currentChannel].type : 'normal';
                if (channelType === 'normal') {
                    socket.emit('morseStop', { channelId: currentChannel });
                }
            }
        }

        // Other users audio
        function startOtherUserTone(senderId) {
            initAudio();
            
            if (otherUsersAudio[senderId]) return;
            
            var osc = audioContext.createOscillator();
            var gain = audioContext.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(config.frequency * 0.85, audioContext.currentTime);
            
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.008);
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.start();
            
            otherUsersAudio[senderId] = { oscillator: osc, gain: gain };
        }

        function stopOtherUserTone(senderId) {
            if (otherUsersAudio[senderId]) {
                var audio = otherUsersAudio[senderId];
                audio.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.008);
                
                setTimeout(function() {
                    try { audio.oscillator.stop(); } catch(e) {}
                }, 15);
                
                delete otherUsersAudio[senderId];
            }
        }

        function playReceivedMorse(morse) {
            initAudio();
            
            var elements = morse.split('');
            var index = 0;
            var otherFreq = config.frequency * 0.85;
            
            function playNext() {
                if (index >= elements.length) return;
                
                var el = elements[index];
                index++;
                
                if (el === '.' || el === '-') {
                    var dur = el === '.' ? getDitLength() : getDahLength();
                    
                    var osc = audioContext.createOscillator();
                    var gain = audioContext.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(otherFreq, audioContext.currentTime);
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.start();
                    osc.stop(audioContext.currentTime + dur / 1000);
                    
                    setTimeout(playNext, dur + getElementSpace());
                } else if (el === ' ') {
                    setTimeout(playNext, getLetterSpace());
                } else if (el === '/') {
                    setTimeout(playNext, getWordSpace());
                } else {
                    playNext();
                }
            }
            
            playNext();
        }

        // ========== IAMBIC KEYER ==========
        function playElement(element) {
            var channelType = channelData[currentChannel] ? channelData[currentChannel].type : 'normal';
            if (channelType === 'lobby') return;
            
            keyerState.isPlaying = true;
            startTone();
            
            var duration = element === '.' ? getDitLength() : getDahLength();
            keyerState.currentMorse += element;
            
            // Visual indicator
            var indicator = element === '.' ? 'ditIndicator' : 'dahIndicator';
            document.getElementById(indicator).classList.add('active');
            
            // Update current line
            updateCurrentLine();
            
            // Reset letter timeout
            if (keyerState.letterTimeout) {
                clearTimeout(keyerState.letterTimeout);
                keyerState.letterTimeout = null;
            }
            
            setTimeout(function() {
                stopTone();
                document.getElementById('ditIndicator').classList.remove('active');
                document.getElementById('dahIndicator').classList.remove('active');
                
                keyerState.lastKeyTime = Date.now();
                keyerState.lastElement = element;
                
                // Set letter timeout
                keyerState.letterTimeout = setTimeout(function() {
                    finalizeLetter();
                }, getLetterSpace());
                
                setTimeout(function() {
                    keyerState.isPlaying = false;
                    processNextElement();
                }, getElementSpace());
            }, duration);
        }

        function processNextElement() {
            if (keyerState.isPlaying) return;

            var ditKey = config.reverse ? keyerState.dahPressed : keyerState.ditPressed;
            var dahKey = config.reverse ? keyerState.ditPressed : keyerState.dahPressed;

            if (config.mode === 'B') {
                if (ditKey && dahKey) {
                    playElement(keyerState.lastElement === '.' ? '-' : '.');
                } else if (ditKey) {
                    playElement('.');
                } else if (dahKey) {
                    playElement('-');
                }
            } else {
                if (ditKey) {
                    playElement('.');
                } else if (dahKey) {
                    playElement('-');
                }
            }
        }

        function finalizeLetter() {
            if (keyerState.currentMorse) {
                var letter = reverseMorseTable[keyerState.currentMorse];
                if (letter) {
                    keyerState.currentText += letter;
                } else {
                    keyerState.currentText += '[' + keyerState.currentMorse + ']';
                }
                updateCurrentLine();
                keyerState.currentMorse = '';
                
                // Set word timeout
                if (keyerState.wordTimeout) {
                    clearTimeout(keyerState.wordTimeout);
                }
                keyerState.wordTimeout = setTimeout(function() {
                    if (keyerState.currentText && !keyerState.currentText.endsWith(' ')) {
                        keyerState.currentText += ' ';
                        updateCurrentLine();
                    }
                }, getWordSpace() - getLetterSpace());
                
                // Set line finalization timeout (5 seconds)
                if (keyerState.lineTimeout) {
                    clearTimeout(keyerState.lineTimeout);
                }
                keyerState.lineTimeout = setTimeout(function() {
                    finalizeLine();
                }, 5000);
            }
        }

        function updateCurrentLine() {
            var channelType = channelData[currentChannel] ? channelData[currentChannel].type : 'normal';
            if (channelType === 'lobby') return;
            
            if (!keyerState.currentLineElement) {
                keyerState.currentLineElement = createNewLine();
            }
            
            var morseCodeEl = keyerState.currentLineElement.querySelector('.morse-code');
            var morseTextEl = keyerState.currentLineElement.querySelector('.morse-text');
            
            var displayMorse = '';
            if (keyerState.currentText) {
                var chars = keyerState.currentText.split('');
                var morseParts = [];
                for (var i = 0; i < chars.length; i++) {
                    var m = morseTable[chars[i]];
                    if (m) morseParts.push(m);
                    else if (chars[i] === ' ') morseParts.push('/');
                }
                displayMorse = morseParts.join(' ');
            }
            if (keyerState.currentMorse) {
                displayMorse += (displayMorse ? ' ' : '') + keyerState.currentMorse;
            }
            
            morseCodeEl.textContent = displayMorse;
            morseTextEl.innerHTML = keyerState.currentText + '<span class="cursor">‚ñå</span>';
            
            scrollToBottom();
        }

        function createNewLine() {
            var display = document.getElementById('morseDisplay');
            var line = document.createElement('div');
            line.className = 'morse-line current';
            line.innerHTML = 
                '<span class="morse-timestamp">' + getTimestamp() + '</span>' +
                '<span class="morse-user">' + config.username + ':</span>' +
                '<div class="morse-content">' +
                    '<div class="morse-code"></div>' +
                    '<div class="morse-text"><span class="cursor">‚ñå</span></div>' +
                '</div>';
            display.appendChild(line);
            return line;
        }

        function finalizeLine() {
            if (keyerState.currentLineElement) {
                keyerState.currentLineElement.classList.remove('current');
                var cursor = keyerState.currentLineElement.querySelector('.cursor');
                if (cursor) cursor.remove();
                
                // Send message
                if (keyerState.currentText.trim()) {
                    var text = keyerState.currentText.trim();
                    var morse = textToMorse(text);
                    
                    socket.emit('morseMessage', {
                        text: text,
                        morse: morse,
                        channelId: currentChannel
                    });
                }
            }
            
            keyerState.currentLineElement = null;
            keyerState.currentText = '';
            keyerState.currentMorse = '';
            
            // Clear timeouts
            if (keyerState.letterTimeout) clearTimeout(keyerState.letterTimeout);
            if (keyerState.wordTimeout) clearTimeout(keyerState.wordTimeout);
            if (keyerState.lineTimeout) clearTimeout(keyerState.lineTimeout);
            keyerState.letterTimeout = null;
            keyerState.wordTimeout = null;
            keyerState.lineTimeout = null;
        }

        function textToMorse(text) {
            var result = [];
            for (var i = 0; i < text.length; i++) {
                var char = text[i].toUpperCase();
                if (morseTable[char]) {
                    result.push(morseTable[char]);
                } else if (char === ' ') {
                    result.push('/');
                }
            }
            return result.join(' ');
        }

        // ========== KEYBOARD EVENTS ==========
        document.addEventListener('keydown', function(e) {
            if (e.repeat) return;
            
            // Don't capture if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.code === 'ControlLeft') {
                e.preventDefault();
                initAudio();
                keyerState.ditPressed = true;
                if (!keyerState.isPlaying) processNextElement();
            } else if (e.code === 'ControlRight') {
                e.preventDefault();
                initAudio();
                keyerState.dahPressed = true;
                if (!keyerState.isPlaying) processNextElement();
            }
        });

        document.addEventListener('keyup', function(e) {
            if (e.code === 'ControlLeft') {
                e.preventDefault();
                keyerState.ditPressed = false;
            } else if (e.code === 'ControlRight') {
                e.preventDefault();
                keyerState.dahPressed = false;
            }
        });

        // ========== UTILITY FUNCTIONS ==========
        function getTimestamp() {
            var now = new Date();
            var h = now.getHours().toString().padStart(2, '0');
            var m = now.getMinutes().toString().padStart(2, '0');
            return h + ':' + m;
        }

        function scrollToBottom() {
            var display = document.getElementById('morseDisplay');
            display.scrollTop = display.scrollHeight;
        }

        function clearDisplay() {
            document.getElementById('morseDisplay').innerHTML = '';
            keyerState.currentLineElement = null;
            keyerState.currentText = '';
            keyerState.currentMorse = '';
            addSystemMessage('Display cleared');
        }

        function addSystemMessage(text) {
            var display = document.getElementById('morseDisplay');
            var line = document.createElement('div');
            line.className = 'morse-line system';
            line.innerHTML = 
                '<span class="morse-timestamp">' + getTimestamp() + '</span>' +
                '<span class="morse-user system">SYSTEM:</span>' +
                '<div class="morse-content">' +
                    '<div class="morse-text">' + text + '</div>' +
                '</div>';
            display.appendChild(line);
            scrollToBottom();
        }

        function addBotMessage(callsign, morse, text) {
            var display = document.getElementById('morseDisplay');
            var line = document.createElement('div');
            line.className = 'morse-line bot-message';
            line.innerHTML = 
                '<span class="morse-timestamp">' + getTimestamp() + '</span>' +
                '<span class="morse-user bot">ü§ñ ' + callsign + ':</span>' +
                '<div class="morse-content">' +
                    '<div class="morse-code">' + (morse || '') + '</div>' +
                    '<div class="morse-text">' + text + '</div>' +
                '</div>';
            display.appendChild(line);
            scrollToBottom();
        }

        function addOtherUserMessage(username, morse, text) {
            var display = document.getElementById('morseDisplay');
            var line = document.createElement('div');
            line.className = 'morse-line other-user';
            line.innerHTML = 
                '<span class="morse-timestamp">' + getTimestamp() + '</span>' +
                '<span class="morse-user other">' + username + ':</span>' +
                '<div class="morse-content">' +
                    '<div class="morse-code">' + (morse || '') + '</div>' +
                    '<div class="morse-text">' + text + '</div>' +
                '</div>';
            display.appendChild(line);
            scrollToBottom();
            
            // Play morse audio
            if (morse) {
                playReceivedMorse(morse);
            }
        }

        function toggleHelp() {
            var helpPanel = document.getElementById('qsoHelp');
            var helpToggle = document.getElementById('helpToggle');
            
            if (helpPanel.classList.contains('active')) {
                helpPanel.classList.remove('active');
                helpToggle.style.display = 'flex';
            } else {
                helpPanel.classList.add('active');
                helpToggle.style.display = 'none';
            }
        }

        // ========== CHANNEL FUNCTIONS ==========
        function renderChannels() {
            var channelsList = document.getElementById('channelsList');
            channelsList.innerHTML = '';

            // Special channels
            var specialSection = document.createElement('div');
            specialSection.className = 'channel-section';
            specialSection.innerHTML = '<div class="channel-section-title">üìå SPECIAL</div>';
            
            var specialIds = ['LOBBY', 'PRACTICE'];
            for (var i = 0; i < specialIds.length; i++) {
                var id = specialIds[i];
                var channel = channelData[id];
                var item = createChannelItem(id, channel);
                specialSection.appendChild(item);
            }
            channelsList.appendChild(specialSection);

            // Public channels
            var publicSection = document.createElement('div');
            publicSection.className = 'channel-section';
            publicSection.innerHTML = '<div class="channel-section-title">üì° PUBLIC CHANNELS</div>';
            
            var publicIds = ['CH1', 'CH2', 'CH3', 'CH4', 'CH5', 'CH6', 'CH7', 'CH8'];
            for (var j = 0; j < publicIds.length; j++) {
                var pId = publicIds[j];
                var pChannel = channelData[pId];
                var pItem = createChannelItem(pId, pChannel);
                publicSection.appendChild(pItem);
            }
            channelsList.appendChild(publicSection);

            // Private channels
            if (config.privateChannels.length > 0) {
                var privateSection = document.createElement('div');
                privateSection.className = 'channel-section';
                privateSection.innerHTML = '<div class="channel-section-title">üîí PRIVATE CHANNELS</div>';
                
                for (var k = 0; k < config.privateChannels.length; k++) {
                    var name = config.privateChannels[k];
                    var privId = 'PRIV_' + name;
                    var privItem = document.createElement('div');
                    privItem.className = 'channel-item private';
                    if (currentChannel === privId) privItem.classList.add('active');
                    
                    var privUsers = channelUserCounts[privId] || 0;
                    privItem.innerHTML = 
                        '<span class="channel-name">' + name + '</span>' +
                        '<div class="channel-info">' +
                            '<span class="user-count">üë• ' + privUsers + '</span>' +
                            '<span class="channel-status ' + (currentChannel === privId ? 'active-status' : '') + '"></span>' +
                        '</div>';
                    
                    (function(pName, pPrivId) {
                        privItem.onclick = function() {
                            switchChannel(pPrivId, pName, 'Canal priv√©');
                        };
                    })(name, privId);
                    
                    privateSection.appendChild(privItem);
                }
                channelsList.appendChild(privateSection);
            }

            updateTotalUsers();
        }

        function createChannelItem(id, channel) {
            var item = document.createElement('div');
            item.className = 'channel-item ' + channel.type;
            if (currentChannel === id) item.classList.add('active');
            
            var userCount = channelUserCounts[id] || 0;
            var displayUsers = userCount;
            
            if (id === 'PRACTICE') {
                displayUsers = 'ü§ñ BOT';
            }
            
            item.innerHTML = 
                '<span class="channel-name">' + channel.name + '</span>' +
                '<div class="channel-info">' +
                    '<span class="user-count">üë• ' + displayUsers + '</span>' +
                    '<span class="channel-status ' + (currentChannel === id ? 'active-status' : '') + '"></span>' +
                '</div>';
            
            (function(channelId, channelName, channelDesc) {
                item.onclick = function() {
                    switchChannel(channelId, channelName, channelDesc);
                };
            })(id, channel.name, channel.description);
            
            return item;
        }

        function switchChannel(id, name, description) {
            finalizeLine();
            
            currentChannel = id;
            document.getElementById('channelTitle').textContent = name;
            document.getElementById('channelDescription').textContent = description;
            
            // Notify server
            socket.emit('joinChannel', {
                channelId: id,
                username: config.username
            });
            
            document.getElementById('morseDisplay').innerHTML = '';
            
            var channelInfo = channelData[id];
            var channelType = channelInfo ? channelInfo.type : 'private';
            
            document.getElementById('mutedOverlay').classList.remove('active');
            document.getElementById('practiceBar').classList.remove('active');
            
            if (channelType === 'lobby') {
                document.getElementById('mutedOverlay').classList.add('active');
                addSystemMessage('Bienvenue dans le Lobby. Ce canal est en mode silencieux.');
            } else if (channelType === 'practice') {
                document.getElementById('practiceBar').classList.add('active');
                addSystemMessage('üéØ Mode Practice avec Bot CW intelligent.');
                addSystemMessage('üìö Tapez CQ ou cliquez START QSO pour commencer.');
                
                // Reset bot state
                botState = { profile: null, qsoState: 'idle', isActive: false };
                updateBotDisplay();
            } else {
                addSystemMessage('Connect√© √† ' + name + '. Bonne transmission!');
            }
            
            renderChannels();
        }

        function updateTotalUsers() {
            var total = 0;
            for (var id in channelUserCounts) {
                total += channelUserCounts[id];
            }
            document.getElementById('totalUsers').textContent = 'üë• ' + total + ' online';
        }

        // ========== SETTINGS ==========
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            config.wpm = parseInt(document.getElementById('wpmSlider').value);
            config.frequency = parseInt(document.getElementById('freqSlider').value);
            config.mode = document.getElementById('iambicMode').value;
            config.reverse = document.getElementById('reverseKeys').checked;
            config.username = document.getElementById('username').value.toUpperCase() || 'VISITOR';
            config.botQsoType = document.getElementById('botQsoType').value;
            config.botDifficulty = document.getElementById('botDifficulty').value;
            config.botAutoStart = document.getElementById('botAutoStart').checked;
            config.showBotAnalysis = document.getElementById('showBotAnalysis').checked;
            
            document.getElementById('wpmDisplay').textContent = config.wpm;
            document.getElementById('freqDisplay').textContent = config.frequency + ' Hz';
            document.getElementById('modeDisplay').textContent = 'IAMBIC-' + config.mode;
            document.getElementById('userDisplay').textContent = config.username;
            
            document.getElementById('settingsModal').classList.remove('active');
            saveSettings();
            
            // Update server with new username
            socket.emit('joinChannel', {
                channelId: currentChannel,
                username: config.username
            });
            
            // Configure bot if in practice
            if (currentChannel === 'PRACTICE') {
                socket.emit('configureBot', {
                    qsoType: config.botQsoType,
                    difficulty: config.botDifficulty
                });
            }
            
            renderChannels();
        }

        function applyPrivateChannels() {
            var input = document.getElementById('privateChannels').value;
            var channels = input.split(',');
            config.privateChannels = [];
            
            for (var i = 0; i < channels.length; i++) {
                var name = channels[i].trim();
                if (name.length > 0 && name.length <= 15) {
                    config.privateChannels.push(name);
                    socket.emit('createPrivateChannel', name);
                }
            }
            
            renderChannels();
            saveSettings();
            
            if (config.privateChannels.length > 0) {
                alert('‚úì ' + config.privateChannels.length + ' canal(aux) priv√©(s) cr√©√©(s):\n' + config.privateChannels.join(', '));
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('morseNetSettings', JSON.stringify(config));
            } catch(e) {}
        }

        function loadSettings() {
            try {
                var saved = localStorage.getItem('morseNetSettings');
                if (saved) {
                    var settings = JSON.parse(saved);
                    config.wpm = settings.wpm || 20;
                    config.frequency = settings.frequency || 700;
                    config.mode = settings.mode || 'B';
                    config.reverse = settings.reverse || false;
                    config.username = settings.username || 'VISITOR';
                    config.privateChannels = settings.privateChannels || [];
                    config.botQsoType = settings.botQsoType || 'casual';
                    config.botDifficulty = settings.botDifficulty || 'beginner';
                    config.botAutoStart = settings.botAutoStart !== false;
                    config.showBotAnalysis = settings.showBotAnalysis || false;
                    
                    document.getElementById('wpmSlider').value = config.wpm;
                    document.getElementById('freqSlider').value = config.frequency;
                    document.getElementById('iambicMode').value = config.mode;
                    document.getElementById('reverseKeys').checked = config.reverse;
                    document.getElementById('username').value = config.username;
                    document.getElementById('privateChannels').value = config.privateChannels.join(', ');
                    document.getElementById('botQsoType').value = config.botQsoType;
                    document.getElementById('botDifficulty').value = config.botDifficulty;
                    document.getElementById('botAutoStart').checked = config.botAutoStart;
                    document.getElementById('showBotAnalysis').checked = config.showBotAnalysis;
                    
                    document.getElementById('wpmValue').textContent = config.wpm + ' WPM';
                    document.getElementById('freqValue').textContent = config.frequency + ' Hz';
                    document.getElementById('wpmDisplay').textContent = config.wpm;
                    document.getElementById('freqDisplay').textContent = config.frequency + ' Hz';
                    document.getElementById('modeDisplay').textContent = 'IAMBIC-' + config.mode;
                    document.getElementById('userDisplay').textContent = config.username;
                }
            } catch(e) {}
        }

        // Settings sliders
        document.getElementById('wpmSlider').addEventListener('input', function() {
            document.getElementById('wpmValue').textContent = this.value + ' WPM';
        });

        document.getElementById('freqSlider').addEventListener('input', function() {
            document.getElementById('freqValue').textContent = this.value + ' Hz';
        });

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            renderChannels();
            updateConnectionStatus('connecting');
        });

        document.addEventListener('contextmenu', function(e) {
            if (e.ctrlKey) e.preventDefault();
        });

        window.addEventListener('beforeunload', saveSettings);
    </script>
</body>
</html>
